<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrestaPro | Sistema de Pr√©stamos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf-autotable.min.js"></script>

    <style>
        /* Estilos sin cambios */
        :root {
            --primary-color: #005DFF; --primary-light: #E6F0FF; --secondary-color: #0D244F;
            --text-color: #344054; --light-gray: #F2F4F7; --border-color: #D0D5DD;
            --white: #FFFFFF; --success-color: #12B76A;
            --font-family: 'Poppins', sans-serif;
        }
        body { font-family: var(--font-family); background-color: var(--light-gray); color: var(--text-color); margin: 0; }
        .main-header { background-color: var(--white); padding: 15px 40px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .main-header h1 { color: var(--primary-color); font-size: 24px; margin: 0; }
        .container { padding: 30px 40px; }
        .card { background: var(--white); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .card-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { font-size: 20px; font-weight: 600; color: var(--secondary-color); margin: 0; }
        .button { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
        .button-primary { background-color: var(--primary-color); color: var(--white); }
        .button-primary:hover { background-color: #0045B8; transform: translateY(-2px); }
        .button-secondary { background-color: #F2F4F7; color: #344054; border: 1px solid #D0D5DD;}
        .button-secondary:hover { background-color: #E4E7EC; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 30px; }
        .stat-card { background-color: var(--white); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); }
        .stat-card h3 { margin: 0 0 8px 0; color: #667085; font-size: 14px; font-weight: 500; }
        .stat-card .value { font-size: 28px; font-weight: 600; color: var(--secondary-color); }
        .table-container { overflow-x: auto; max-height: 500px; overflow-y: auto; }
        .main-table { width: 100%; border-collapse: collapse; }
        .main-table th, .main-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .main-table th { background-color: #F9FAFB; font-size: 12px; font-weight: 600; text-transform: uppercase; color: #667085; }
        .main-table td { font-size: 14px; }
        .status { padding: 4px 10px; border-radius: 16px; font-size: 12px; font-weight: 500; text-align: center;}
        .status-active { background-color: var(--primary-light); color: var(--primary-color); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(13, 36, 79, 0.6); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--white); border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: slideIn 0.4s ease-out; display: flex; flex-direction: column; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-header h2 { font-size: 20px; color: var(--secondary-color); margin: 0; }
        .close-button { background: none; border: none; font-size: 24px; cursor: pointer; color: #98A2B3; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); background-color: #F9FAFB; flex-shrink: 0; display: flex; justify-content: flex-end; gap: 12px; }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        fieldset { border: none; padding: 0; margin: 0 0 24px 0; }
        legend { font-size: 16px; font-weight: 600; color: var(--secondary-color); margin-bottom: 16px; }
        .form-row { display: flex; gap: 20px; }
        .form-group { flex: 1; display: flex; flex-direction: column; margin-bottom: 16px; }
        .form-group label { font-size: 14px; font-weight: 500; margin-bottom: 6px; }
        input { width: 100%; padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .submit-button { width: 100%; padding: 12px; background: var(--primary-color); color: var(--white); border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; margin-top: 10px; }
        .summary-info { padding: 16px; background-color: var(--primary-light); border-radius: 8px; margin-bottom: 24px; border: 1px solid var(--primary-color); font-size: 14px; }
        .summary-info p { margin: 0 0 8px 0; }
        .summary-info p:last-child { margin-bottom: 0; }
        .printable { flex-grow: 1; overflow-y: auto; min-height: 0; }
        @media print {
            body * { visibility: hidden; }
            .printable, .printable * { visibility: visible; }
            .printable { position: absolute; left: 0; top: 0; width: 100%; overflow-y: visible; }
            #detailsModal .modal-content { border: none; box-shadow: none; max-height: none; }
            #detailsModal .modal-footer, #detailsModal .close-button { display: none; }
        }
    </style>
</head>
<body>
<header class="main-header">
    <h1>PrestaPro üí∞</h1>
    <button class="button button-primary" id="addLoanBtn">+ A√±adir Nuevo Pr√©stamo</button>
</header>
<main class="container">
    <div class="dashboard">
        <div class="stat-card"><h3>Monto Total Prestado</h3><div class="value" id="totalLoaned">S/ 0.00</div></div>
        <div class="stat-card"><h3>Pr√©stamos Activos</h3><div class="value" id="activeLoans">0</div></div>
        <div class="stat-card"><h3>Clientes Totales</h3><div class="value" id="totalClients">0</div></div>
    </div>
    <div class="card">
        <div class="card-header"><h2>Historial de Pr√©stamos</h2></div>
        <div class="card-body">
            <div class="table-container">
                <table id="historyTable" class="main-table">
                    <thead><tr><th>Cliente</th><th>Monto</th><th>Fecha</th><th>Plazo</th><th>Estado</th><th>Acciones</th></tr></thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>
<div id="loanModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2>Registrar Nuevo Pr√©stamo</h2><button class="close-button" id="closeModalBtn">&times;</button></div>
        <div class="modal-body"><form id="loanForm"></form></div>
    </div>
</div>
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <div class="printable">
            <div class="modal-header">
                <h2>üóìÔ∏è Cronograma de Pagos</h2>
                <button class="close-button" id="closeDetailsModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="scheduleSummary" class="summary-info"></div>
                <div class="table-container" style="max-height: none; overflow-y: visible;">
                    <table id="scheduleTable" class="main-table">
                        <thead><tr><th>Cuota</th><th>Fecha de Vencimiento</th><th>Monto</th></tr></thead>
                        <tbody id="scheduleTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="button button-secondary" id="shareBtn">üîó Compartir</button>
            <button class="button button-primary" id="printScheduleBtn">üñ®Ô∏è Imprimir</button>
        </div>
    </div>
</div>

<script>
    // --- El JS tiene la nueva l√≥gica a prueba de fallos ---

    let loans = [];
    let clients = new Set();
    let currentLoanForDetails = null;

    const addLoanBtn = document.getElementById('addLoanBtn');
    const loanModal = document.getElementById('loanModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const loanForm = document.getElementById('loanForm');
    const historyTableBody = document.getElementById('historyTableBody');
    const detailsModal = document.getElementById('detailsModal');
    const closeDetailsModalBtn = document.getElementById('closeDetailsModalBtn');
    const printScheduleBtn = document.getElementById('printScheduleBtn');
    const shareBtn = document.getElementById('shareBtn');

    // ... (El c√≥digo para llenar el formulario y manejar los modales es el mismo)
    loanForm.innerHTML = `
        <fieldset>
            <legend>üë§ Informaci√≥n del Cliente</legend>
            <div class="form-group"><label for="dni">DNI</label><input type="text" id="dni" placeholder="Ej: 71234567" required pattern="\\d{8}"></div>
            <div class="form-row">
                <div class="form-group"><label for="nombres">Nombres</label><input type="text" id="nombres" placeholder="Nombres completos" required></div>
                <div class="form-group"><label for="apellidos">Apellidos</label><input type="text" id="apellidos" placeholder="Apellidos completos" required></div>
            </div>
        </fieldset>
        <fieldset>
            <legend>üìã Detalles del Pr√©stamo</legend>
            <div class="form-row">
                <div class="form-group"><label for="monto">Monto (S/)</label><input type="number" id="monto" placeholder="Ej: 1000" required step="0.01"></div>
                <div class="form-group"><label for="fecha">Fecha</label><input type="date" id="fecha" required></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label for="interes">Inter√©s Mensual (%)</label><input type="number" id="interes" placeholder="Ej: 3.5" required step="0.01"></div>
                <div class="form-group"><label for="plazo">Plazo (Meses)</label><input type="number" id="plazo" placeholder="Ej: 12" required></div>
            </div>
        </fieldset>
        <button type="submit" class="submit-button">Guardar Pr√©stamo</button>
    `;
    const openModal = (modal) => modal.style.display = 'flex';
    const closeModal = (modal) => {
        modal.style.display = 'none';
        if(modal.id === 'detailsModal') {
            currentLoanForDetails = null;
        }
    };
    addLoanBtn.addEventListener('click', () => openModal(loanModal));
    closeModalBtn.addEventListener('click', () => closeModal(loanModal));
    closeDetailsModalBtn.addEventListener('click', () => closeModal(detailsModal));
    printScheduleBtn.addEventListener('click', () => window.print());
    window.addEventListener('click', (event) => {
        if (event.target === loanModal) closeModal(loanModal);
        if (event.target === detailsModal) closeModal(detailsModal);
    });
    loanForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const newLoan = {
            id: Date.now(),
            client: { dni: document.getElementById('dni').value, nombres: document.getElementById('nombres').value, apellidos: document.getElementById('apellidos').value, },
            monto: parseFloat(document.getElementById('monto').value),
            interes: parseFloat(document.getElementById('interes').value),
            fecha: document.getElementById('fecha').value,
            plazo: parseInt(document.getElementById('plazo').value),
            status: 'Activo'
        };
        loans.push(newLoan);
        clients.add(newLoan.client.dni);
        renderHistoryTable();
        updateDashboard();
        loanForm.reset();
        closeModal(loanModal);
    });
    function renderHistoryTable() {
        historyTableBody.innerHTML = '';
        if (loans.length === 0) {
            historyTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #98A2B3;">A√∫n no hay pr√©stamos registrados.</td></tr>`;
            return;
        }
        loans.forEach(loan => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${loan.client.nombres} ${loan.client.apellidos}</td>
                <td>S/ ${loan.monto.toFixed(2)}</td>
                <td>${new Date(loan.fecha.replace(/-/g, '/')).toLocaleDateString('es-PE')}</td>
                <td>${loan.plazo} meses</td>
                <td><span class="status status-active">${loan.status}</span></td>
                <td><button class="button button-secondary view-details-btn" data-loan-id="${loan.id}">Ver Detalles</button></td>
            `;
            historyTableBody.appendChild(row);
        });
    }
    historyTableBody.addEventListener('click', function(event) {
        if (event.target.classList.contains('view-details-btn')) {
            const loanId = parseInt(event.target.getAttribute('data-loan-id'));
            const loan = loans.find(l => l.id === loanId);
            if (loan) populateDetailsModal(loan);
        }
    });
    function populateDetailsModal(loan) {
        currentLoanForDetails = loan;
        const { monthlyPayment, schedule } = calculateSchedule(loan);
        document.getElementById('scheduleSummary').innerHTML = `
            <p><strong>Cliente:</strong> ${loan.client.nombres} ${loan.client.apellidos}</p>
            <p><strong>Monto:</strong> S/ ${loan.monto.toFixed(2)} | <strong>Inter√©s:</strong> ${loan.interes}% | <strong>Plazo:</strong> ${loan.plazo} meses</p>
            <p><strong>Cuota Mensual Fija: S/ ${monthlyPayment.toFixed(2)}</strong></p>
        `;
        const scheduleTableBody = document.getElementById('scheduleTableBody');
        scheduleTableBody.innerHTML = schedule.map(item => `
            <tr><td>${item.cuota}</td><td>${item.fecha}</td><td>S/ ${item.monto}</td></tr>`).join('');
        openModal(detailsModal);
    }
    function updateDashboard() {
        const totalLoaned = loans.reduce((sum, loan) => sum + loan.monto, 0);
        document.getElementById('totalLoaned').textContent = `S/ ${totalLoaned.toFixed(2)}`;
        document.getElementById('activeLoans').textContent = loans.filter(loan => loan.status === 'Activo').length;
        document.getElementById('totalClients').textContent = clients.size;
    }
    function calculateSchedule(loan) {
        const monthlyInterestRate = loan.interes / 100;
        const monthlyPayment = (loan.monto * monthlyInterestRate) / (1 - Math.pow(1 + monthlyInterestRate, -loan.plazo));
        const schedule = [];
        const startDate = new Date(loan.fecha.replace(/-/g, '/'));
        for (let i = 1; i <= loan.plazo; i++) {
            const paymentDate = new Date(startDate);
            paymentDate.setMonth(paymentDate.getMonth() + i);
            schedule.push({
                cuota: i,
                fecha: paymentDate.toLocaleDateString('es-PE', { year: 'numeric', month: 'long', day: 'numeric' }),
                monto: monthlyPayment.toFixed(2)
            });
        }
        return { monthlyPayment, schedule };
    }

    // --- L√ìGICA MEJORADA Y A PRUEBA DE FALLOS PARA COMPARTIR PDF ---
    async function shareDetailsAsPDF() {
        if (!currentLoanForDetails) return;

        // 1. Verificar si la librer√≠a PDF est√° cargada
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF.autoTable === 'undefined') {
            alert("Error: La librer√≠a para generar PDF no se carg√≥. Revisa tu conexi√≥n a internet.");
            return;
        }

        const loan = currentLoanForDetails;
        const { monthlyPayment, schedule } = calculateSchedule(loan);

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // 2. Generar el contenido del PDF
        doc.setFontSize(18);
        doc.text("Cronograma de Pagos", 14, 22);
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`Cliente: ${loan.client.nombres} ${loan.client.apellidos}`, 14, 32);
        doc.text(`Monto: S/ ${loan.monto.toFixed(2)}`, 14, 38);
        doc.text(`Plazo: ${loan.plazo} meses`, 80, 38);
        doc.text(`Cuota Fija: S/ ${monthlyPayment.toFixed(2)}`, 14, 44);
        const tableColumn = ["Cuota", "Fecha de Vencimiento", "Monto (S/)"];
        const tableRows = schedule.map(item => [item.cuota, item.fecha, item.monto]);
        doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: 55,
        });

        const pdfBlob = doc.output('blob');
        const pdfFile = new File([pdfBlob], `Cronograma-${loan.client.apellidos}.pdf`, { type: 'application/pdf' });
        const filesArray = [pdfFile];

        // 3. Intentar compartir, si falla, descargar
        try {
            // Se usa navigator.canShare para verificar si es posible compartir archivos
            if (navigator.canShare && navigator.canShare({ files: filesArray })) {
                await navigator.share({
                    files: filesArray,
                    title: 'Cronograma de Pagos',
                    text: `Adjunto el cronograma de pagos para ${loan.client.nombres}.`
                });
            } else {
                // Si no se puede compartir, se lanza un error para pasar al bloque catch
                throw new Error("La funci√≥n de compartir no es compatible.");
            }
        } catch (err) {
            console.warn("Funci√≥n de compartir no disponible o cancelada, se proceder√° a descargar.", err);
            // El bloque catch ahora sirve como el m√©todo alternativo (fallback)
            doc.save(`Cronograma-${loan.client.apellidos}.pdf`);
        }
    }

    shareBtn.addEventListener('click', shareDetailsAsPDF);

    // --- Renderizado Inicial ---
    renderHistoryTable();
    updateDashboard();
</script>
</body>
</html>
